---
title: "multivariate_trait_stats"
author: "Liyenne"
date: "2025-05-23"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = here::here("outputs")
    )
  })
cache: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup
```{r}
script_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(file.path(script_dir, "..", ".."))

# data handling
require(tidyverse)

# analysis
require(vegan)
require(gllvm)

# visualization
require(ggplot2)
require(ggrepel)
require(ggordiplots)
require(ggvegan)

require(corrplot)
require(gclus)
```

# Data import
```{r data import}
# trait data
traits_no_chem <- read_csv("2_data/2_clean/traits/traits_no_chem_w.csv") %>% 
  mutate(across(1:10, as.factor))

traits <- read_csv("2_data/2_clean/traits/traits_w.csv") %>% 
  mutate(across(1:10, as.factor))

boot_traits <- read_csv("2_data/2_clean/traits/bootstrapped_traits_bmWeighted.csv") %>% 
  mutate(across(1:6, as.factor)) 
```

```{r}
# community composition data (long)
community <- read_csv("2_data/2_clean/sf_community.csv") %>% 
  mutate(across(1:10, as.factor))

# species list 
spec_list <- read_csv("2_data/1_raw/community/2025/sf_vp_species_list.csv") %>% 
  mutate(across(1:5, as.factor))
```

# PCA 
```{r}
traits %>% 
  na.omit() %>% 
  GGally::ggpairs(columns = c(11, 15:21), 
          mapping = aes(color = habitat))

ggsave("3_output/1_figures/traits/trait_plot_matrix.tif", height = 10, width = 10)
```

## species traits
```{r}
species_traits <- traits %>% 
  filter(complete.cases(.)) %>% 
  group_by(species) %>% 
  summarise(plant_height = mean(height), 
            LDMC = mean(LDMC), 
            SLA = mean(SLA), 
            N = mean(wN), 
            d15N = mean(d15N), 
            C = mean(wC), 
            d13C = mean(d13C), 
            CN_ratio = mean(CN_ratio)) %>% 
  column_to_rownames(var = "species")
```

```{r}
species_pca <- species_traits %>% 
  scale() %>% 
  rda()

summary(species_pca)

species_scores <- as.data.frame(species_pca$CA$u[, 1:2])
species_scores$species <- as.factor(rownames(species_scores))
trait_scores <- as.data.frame(species_pca$CA$v[, 1:2])
trait_scores$trait <- as.factor(rownames(trait_scores))

species_scores <- species_scores %>% 
  left_join(spec_list)

```

```{r}
trait_labs <- c("Plant~height", "LDMC", "SLA",  "'%'~N", "delta^15*N", "'%'~C", "delta^13*C", "C:N~ratio")
names(trait_labs) <- c("plant_height", "LDMC", "SLA",  "wN", "d15N", "wC", "d13C", "CN_ratio")

ggplot() +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.8) + 
  geom_vline(xintercept = 0, linetype = "dotted", alpha = 0.8) +
  geom_segment(data = trait_scores, aes(x = 0, y = 0, xend = 0.9 * PC1, yend = 0.9 * PC2), arrow = arrow(type = "closed", length = unit(0.1, "inches")), color = "gray") +
  geom_point(data = species_scores, aes(x = PC1, y = PC2, color = group), size = 3, alpha = 0.70) + # add the point markers
  geom_text_repel(data = species_scores, aes(x = PC1, y = PC2, label = species, color = group), size = 3.5,  alpha = 0.7) +  # add the species labels
  geom_label(data = trait_scores, aes(PC1, PC2, label = trait_labs), col = "navy", label.size = NA, fill = NA, parse = TRUE) +
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  #coord_equal() +
  theme_classic() +
  #guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        legend.position = "bottom",
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm")) + 
  guides(color = guide_legend(override.aes = list(label = ""))) + 
  labs(x = "PC1 (41%)", y = "PC2 (20%)", color = "Functional group") 
  
ggsave("3_output/1_figures/traits/species_pca.tif", height = 6, width = 6)
```

## traits (with chem)
```{r}
traits_pca <- traits %>% 
  filter(complete.cases(.)) %>% 
  column_to_rownames(var = "ID") %>% 
  select(height, LDMC:CN_ratio) %>% 
  scale() %>% 
  rda()

summary(traits_pca)

site_scores <- as.data.frame(traits_pca$CA$u[, 1:2])
site_scores$ID <- as.factor(rownames(site_scores))
trait_scores <- as.data.frame(traits_pca$CA$v[, 1:2])
trait_scores$trait <- as.factor(rownames(trait_scores))


site_scores <- traits %>%
  select(ID:group) %>% 
  right_join(site_scores)

site_scores[, 11:12] <- site_scores[, 11:12] * 2.5
```

```{r}
trait_labs <- c("Plant~height", "LDMC", "SLA",  "'%'~N", "delta^15*N", "'%'~C", "delta^13*C", "C:N~ratio")
names(trait_labs) <- c("plant_height", "LDMC", "SLA",  "wN", "d15N", "wC", "d13C", "CN_ratio")

ggplot() +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.8) + 
  geom_vline(xintercept = 0, linetype = "dotted", alpha = 0.8) +
  geom_segment(data = trait_scores, aes(x = 0, y = 0, xend = 0.9 * PC1, yend = 0.9 * PC2), arrow = arrow(type = "closed", length = unit(0.1, "inches")), color = "gray") +
  geom_point(data = site_scores, aes(x = PC1, y = PC2, color = group), size = 3, stroke = 1, alpha = 0.70) + # add the point markers
  geom_label(data = trait_scores, aes(PC1, PC2, label = trait_labs), col = "navy", label.size = NA, fill = NA, parse = TRUE) +
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  #coord_equal() +
  theme_classic() +
  #guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        legend.position = "bottom",
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm")) + 
  labs(x = "PC1 (42%)", y = "PC2 (17%)") 

ggsave("3_output/1_figures/traits/traits_pca.tif", height = 6, width = 6)
```

## traits (no chem)
```{r}
traits_no_chem_pca <- traits_no_chem %>% 
  filter(complete.cases(.)) %>% 
  column_to_rownames(var = "code") %>% 
  select(height, LDMC, SLA) %>% 
  scale() %>% 
  rda()

summary(traits_no_chem_pca)

site_scores <- as.data.frame(traits_no_chem_pca$CA$u[, 1:2])
site_scores$ID <- as.factor(rownames(site_scores))
trait_scores <- as.data.frame(traits_no_chem_pca$CA$v[, 1:2])
trait_scores$trait <- as.factor(rownames(trait_scores))

site_scores <- traits_no_chem %>%
  select(code:group) %>% 
  rename(ID = code) %>% 
  right_join(site_scores)

site_scores[, 11:12] <- site_scores[, 11:12] * 2.5
```

```{r}
ggplot() +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.8) + 
  geom_vline(xintercept = 0, linetype = "dotted", alpha = 0.8) +
  geom_segment(data = trait_scores, aes(x = 0, y = 0, xend = 0.9 * PC1, yend = 0.9 * PC2), arrow = arrow(type = "closed", length = unit(0.1, "inches")), color = "gray") +
  geom_point(data = site_scores, aes(x = PC1, y = PC2, color = group), size = 3, alpha = 0.70) + # add the point markers
  geom_label(data = trait_scores, aes(PC1, PC2, label = trait), col = "navy", label.size = NA, fill = NA) +
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  #coord_equal() +
  scale_colour_manual(values = c("#917D53", "#667E4E", "#A8AA97")) +
  scale_fill_manual(values = c("#917D53", "#667E4E", "#A8AA97")) +
  theme_classic() +
  theme_classic() +
  #guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1)) + 
  labs(x = "PC1 (49%)", y = "PC2 (15%)") 
```

## community traits
```{r}
plot_traits <- boot_traits %>% 
  group_by(plot, trait) %>% 
  summarise(boot_mean = mean (mean)) %>% 
  pivot_wider(id_cols = plot, names_from = trait, values_from = boot_mean) %>% 
  column_to_rownames(var = "plot") %>% 
  select(-c(dweight, fweight, leafa)) 

plot_pca <- plot_traits %>% 
  scale() %>% 
  rda()

summary(plot_pca)

site_scores <- as.data.frame(plot_pca$CA$u[, 1:2])
site_scores$ID <- as.factor(rownames(site_scores))
trait_scores <- as.data.frame(plot_pca$CA$v[, 1:2])
trait_scores$trait <- as.factor(rownames(trait_scores))

site_scores <- boot_traits %>%
  select(plot:site) %>% 
  unique() %>% 
  rename(ID = plot) %>% 
  right_join(site_scores)
```

```{r}
trait_labs <- c("C:N~ratio", "delta^13*C", "delta^15*N", "Plant~height", "LDMC", "SLA", "'%'~C",  "'%'~N")
names(trait_labs) <- c("CN_ratio", "d13C", "d15N", "height", "LDMC", "SLA", "wC",  "wN")

ggplot() +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.8) + 
  geom_vline(xintercept = 0, linetype = "dotted", alpha = 0.8) +
  geom_segment(data = trait_scores, aes(x = 0, y = 0, xend = 0.9 * PC1, yend = 0.9 * PC2), arrow = arrow(type = "closed", length = unit(0.1, "inches")), color = "gray") +
  geom_point(data = site_scores, aes(x = PC1, y = PC2, color = habitat, shape = treatment), size = 3, stroke = 1, alpha = .7) + # add the point markers
  geom_label(data = trait_scores, aes(PC1, PC2, label = trait_labs), col = "navy", label.size = NA, fill = NA, parse = TRUE) +
  #geom_text(data = data_scores, aes(x = NMDS1, y = NMDS2, label = plot), vjust=0) +  # add the site labels
  #coord_equal() +
  scale_shape_manual(values = c(16, 8)) +
  scale_colour_manual(values = c("#917D53", "#667E4E", "#A8AA97")) +
  scale_fill_manual(values = c("#917D53", "#667E4E", "#A8AA97")) +
  theme_classic() +
  #guides(color = guide_legend(override.aes = list(shape = NA))) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        legend.position = "bottom",
        legend.box = "vertical",     
        legend.box.just = "left", 
        legend.spacing.y = unit(0, "cm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm")) + 
  labs(x = "PC1 (74%)", y = "PC2 (14%)") 

ggsave("3_output/1_figures/traits/plot_pca.tif", height = 6, width = 6)
```

# Change vs PCA
```{r}
# calculate biomass differences (sf-ctl) per species per site
biomass_diff <- community %>% 
  mutate(site = str_sub(plot, 1, 2)) %>% 
  #pivot_wider(names_from = treatment, values_from = biomass) %>% 
  #group_by(habitat, site, spec, group) %>% 
  #summarise(biomass_diff = sum(snowfence - control, na.rm = TRUE)) %>% 
  left_join(species_scores)
```

```{r}
biomass_diff %>% 
  filter(part == "leaf") %>% 
  ggplot(aes(x = PC1, y = hits, color = treatment)) +
  geom_point()
```

